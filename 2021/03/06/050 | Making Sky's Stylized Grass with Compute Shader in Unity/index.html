<!DOCTYPE html>




<html class="theme-next pisces" lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-bounce.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Ubuntu:300,300italic,400,400italic,700,700italic|Bitter:300,300italic,400,400italic,700,700italic|Bitter:300,300italic,400,400italic,700,700italic|Menlo:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Unity,Shader,URP,Compute Shader,Sky,Grass,">










<meta name="description" content="Sky: Children of the Light is one of my favorite games I am playing recently. During the pandemic, it is a great place where we are able to meet people (or even friends) from all over the world. Beyon">
<meta name="keywords" content="Unity,Shader,URP,Compute Shader,Sky,Grass">
<meta property="og:type" content="article">
<meta property="og:title" content="Making Sky&#39;s Stylized Grass with Compute Shader in Unity">
<meta property="og:url" content="http://www.junhaow.com/2021/03/06/050 | Making Sky's Stylized Grass with Compute Shader in Unity/index.html">
<meta property="og:site_name" content="B_L_OO_GGG">
<meta property="og:description" content="Sky: Children of the Light is one of my favorite games I am playing recently. During the pandemic, it is a great place where we are able to meet people (or even friends) from all over the world. Beyon">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/cyod1.png">
<meta property="og:image" content="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/niyql.JPG">
<meta property="og:image" content="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/2jp8m.gif">
<meta property="og:image" content="http://kylehalladay.com/images/post_images/2014-06-30/gpgpu.jpg">
<meta property="og:image" content="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/5c7ag.png">
<meta property="og:image" content="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/44sn3.png">
<meta property="og:image" content="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/8tx4z.png">
<meta property="og:image" content="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/h16u4.gif">
<meta property="og:image" content="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/j1w4w.gif">
<meta property="og:image" content="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/paz32.gif">
<meta property="og:image" content="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/usb0f.gif">
<meta property="og:image" content="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/vfeyh.png">
<meta property="og:image" content="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/641jj.gif">
<meta property="og:image" content="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/sypqs.png">
<meta property="og:updated_time" content="2021-03-09T00:20:38.287Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Making Sky&#39;s Stylized Grass with Compute Shader in Unity">
<meta name="twitter:description" content="Sky: Children of the Light is one of my favorite games I am playing recently. During the pandemic, it is a great place where we are able to meet people (or even friends) from all over the world. Beyon">
<meta name="twitter:image" content="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/cyod1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.junhaow.com/2021/03/06/050 | Making Sky's Stylized Grass with Compute Shader in Unity/">





  <title>Making Sky's Stylized Grass with Compute Shader in Unity | B_L_OO_GGG</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-146643833-1', 'auto');
  ga('send', 'pageview');
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->





</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="en">


  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">B_L_OO_GGG</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Sumomo mo momo mo no uchi</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home


            

            

            

            

            

          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-inbox"></i> <br>
            
            Archives


            

            
              <span class="badge">50</span>
            

            

            

            

          </a>
        </li>
      
        
        <li class="menu-item menu-item-studynotes">
          <a href="/studynotes/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-pencil"></i> <br>
            
            Study Notes


            

            

            
              <span class="badge">6</span>
            

            

            

          </a>
        </li>
      
        
        <li class="menu-item menu-item-lc">
          <a href="/lc/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            LeetCode Book


            

            

            

            
              <span class="badge badge-lc">251 / âˆž</span>
            

            

          </a>
        </li>
      
        
        <li class="menu-item menu-item-games">
          <a href="/games/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-gamepad"></i> <br>
            
            Games I've Played


            

            

            

            

            

          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-address-card"></i> <br>
            
            About Me


            

            

            

            

            
              <span class="badge-about">ðŸ‘‹</span>
            

          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.junhaow.com/2021/03/06/050 | Making Sky's Stylized Grass with Compute Shader in Unity/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Junhao Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/cat_with_glasses.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="B_L_OO_GGG">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Making Sky's Stylized Grass with Compute Shader in Unity</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-06T17:47:30-08:00">
                03/06/2021
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index">
                    <span itemprop="name">Unity</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/03/06/050 | Making Sky's Stylized Grass with Compute Shader in Unity/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/03/06/050 | Making Sky's Stylized Grass with Compute Shader in Unity/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><a href="https://thatskygame.com/" target="_blank" rel="noopener">Sky: Children of the Light</a> is one of my favorite games I am playing recently. During the pandemic, it is a great place where we are able to meet people (or even friends) from all over the world. Beyond the plot, music, and cosmetics, I enjoyed every second when I was sliding on those beautiful lands, especially the stylized grass on top of them. In this post, I will share my experience in reproducing the grass in Unity under Universal Render Pipeline (v7.5.3). You will get result like the following:</p>
<p><img src="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/cyod1.png" alt="" title="Sky&#39;s Stylized Grass"></p>
<a id="more"></a>
<p><img src="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/niyql.JPG" alt="" title="Stylized Grass in Sky: Children of the Light (my in-game screenshot)"></p>
<p>Be aware that this post is not a tutorial, but you will find all the information you need from attached references (tutorial blogs, YouTube videos, etc) and the comments I wrote in source files. Unusually, I decided to use compute shaders because I develop on Metal API and it does not support geometry shaders. Donâ€™t worry! It is much easier to implement the same effect in a geometry shader (less 1,000 lines of code I believe).</p>
<p><img src="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/2jp8m.gif" alt="" title="Reproduce Sky&#39;s Stylized Grass"></p>
<h2 id="How-To-Set-Up-TL-DR"><a href="#How-To-Set-Up-TL-DR" class="headerlink" title="How To Set Up (TL;DR)"></a>How To Set Up (TL;DR)</h2><p>You can use the shaders and scripts I wrote right away. To make the shaders more usable in games, I paint the grass with the help of the <a href="https://www.youtube.com/watch?v=xKJHL8nQiuM&amp;ab_channel=MinionsArt" target="_blank" rel="noopener">painter tool</a> made by MinionsArt. Check out the website if you are interested in learning how the tool works from behind. I made some changes to the two original files to add shortcut and compute shader support.</p>
<h3 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h3><ol>
<li>Download three shader files<ol>
<li><a href="https://gist.github.com/junhaowww/fb6c030c17fe1e109a34f1c92571943f#file-skylikegrass-shader" target="_blank" rel="noopener">SkylikeGrass.shader</a> (shader file)</li>
<li><a href="https://gist.github.com/junhaowww/fb6c030c17fe1e109a34f1c92571943f#file-skylikegrass-hlsl" target="_blank" rel="noopener">SkylikeGrass.hlsl</a> (main shader logic that contains <code>vertex</code> and <code>fragment</code> functions)</li>
<li><a href="https://gist.github.com/junhaowww/fb6c030c17fe1e109a34f1c92571943f#file-skylikegrasscompute-compute" target="_blank" rel="noopener">SkylikeGrassCompute.compute</a> (compute shader)</li>
</ol>
</li>
<li>Create two materials that use <code>Grass/SkylikeGrass</code> shader.<ol>
<li><code>SkylikeStripMaterial</code> and set the <a href="https://github.com/junhaowww/StorageBaseWithoutCatNotice/blob/main/grass_strip.png" target="_blank" rel="noopener">strip texture</a></li>
<li><code>SkylikeCircleMaterial</code> and set the <a href="https://github.com/junhaowww/StorageBaseWithoutCatNotice/blob/main/grass_circle_blur.png" target="_blank" rel="noopener">circle texture</a></li>
<li>After importing texture files, go to inspector:<ol>
<li>Check <code>Alpha Is Transparency</code></li>
<li>Set <code>Wrap Mode</code> to <code>Clamp</code></li>
</ol>
</li>
</ol>
</li>
<li>Set up painter tool and renderer<ol>
<li>Download <a href="https://gist.github.com/junhaowww/fb6c030c17fe1e109a34f1c92571943f#file-skylikegrasspainter-cs" target="_blank" rel="noopener">SkylikeGrassPainter.cs</a> and import</li>
<li>Download <a href="https://gist.github.com/junhaowww/fb6c030c17fe1e109a34f1c92571943f#file-skylikegrasspaintereditor-cs" target="_blank" rel="noopener">SkylikeGrassPainterEditor.cs</a> and put it to <code>Assets/Editor</code></li>
<li>Download <a href="https://gist.github.com/junhaowww/fb6c030c17fe1e109a34f1c92571943f#file-skylikegrasscomputerenderer-cs" target="_blank" rel="noopener">SkylikeGrassComputeRenderer.cs</a> and import</li>
</ol>
</li>
<li>Set up painting<ol>
<li>Create a plane where the painter tool draws on</li>
<li>Create an empty game object<ol>
<li>Add <code>SkylikeGrassPainter</code> script component</li>
<li>Add <code>SkylikeGrassComputeRenderer</code> script component</li>
<li>Manually set material and compute shader accordingly</li>
</ol>
</li>
</ol>
</li>
<li>Start painting!<ol>
<li>Make sure the empty game object is selected</li>
<li>Paint grass by holding any modifier key (e.g. <code>Shift</code>, <code>Ctrl</code>) and <code>right mouse button</code></li>
<li>Switch tool with any modifier key (e.g. <code>Shift</code>, <code>Ctrl</code>) and <code>middle mouse button</code></li>
</ol>
</li>
</ol>
<p>Hope you are enjoy this shader in your game! To get rid of setup overhead, it would be convenient if you prefab the empty object with a particular material, then next time you just drag the prefab to the scene to start painting. All the presets will be stored.</p>
<p>In addition, if you want to bring in interactive effect, download <a href="https://gist.github.com/junhaowww/fb6c030c17fe1e109a34f1c92571943f#file-shaderinteractor-cs" target="_blank" rel="noopener">ShaderInteractor.cs</a> and attach it to your player object. You can find the original file from MinionsArtâ€™s website as well.</p>
<h2 id="Painter-Tool"><a href="#Painter-Tool" class="headerlink" title="Painter Tool"></a>Painter Tool</h2><p>The painter tool is defined in <a href="https://gist.github.com/junhaowww/fb6c030c17fe1e109a34f1c92571943f#file-skylikegrasspainter-cs" target="_blank" rel="noopener">SkylikeGrassPainter.cs</a> and <a href="https://gist.github.com/junhaowww/fb6c030c17fe1e109a34f1c92571943f#file-skylikegrasspaintereditor-cs" target="_blank" rel="noopener">SkylikeGrassPainterEditor.cs</a>. Whenever you plant some grass on the ground, it will create a new mesh and store vertices which contain the information needed in our compute shader. Then this mesh will be accessed from <code>SkylikeGrassComputeRenderer</code> which uploads the data to compute shader. At the end of <code>SkylikeGrassPainter</code>, there are few lines doing the mesh work.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// set all info to mesh</span></span><br><span class="line">mesh = <span class="keyword">new</span> Mesh();</span><br><span class="line">mesh.name = <span class="string">"Grass Mesh - "</span> + name;</span><br><span class="line">mesh.SetVertices(positions);</span><br><span class="line">indi = indices.ToArray();</span><br><span class="line">mesh.SetIndices(indi, MeshTopology.Points, <span class="number">0</span>);</span><br><span class="line">mesh.SetUVs(<span class="number">0</span>, grassSizeMultipliers);</span><br><span class="line">mesh.SetColors(colors);</span><br><span class="line">mesh.SetNormals(normals);</span><br><span class="line">filter.mesh = mesh;</span><br></pre></td></tr></table></figure>
<p><code>MeshTopology.Points</code> indicates that the program will treat vertices individually. This makes sense since grass only spawns on a particular location.</p>
<p>Beside vertices, we store size multipliers inside UV0 (channel 0). This <code>Vector2</code> allows us to assign particular size to each vertex. Therefore, without changing the grass size in <code>SkylikeGrassComputeRenderer</code>, we can use the painter tool to vary grass size easily. This applies to grass color as well.</p>
<p>Again, to know more about the tool, please check out MinionsArtâ€™s website.</p>
<ul>
<li><a href="https://www.patreon.com/posts/geometry-grass-46836032" target="_blank" rel="noopener">Geometry Grass Shader + Tool video + update</a> (by MinionsArt)</li>
</ul>
<h2 id="Compute-Shader"><a href="#Compute-Shader" class="headerlink" title="Compute Shader"></a>Compute Shader</h2><h3 id="Learning-Resources"><a href="#Learning-Resources" class="headerlink" title="Learning Resources"></a>Learning Resources</h3><p>Compute shaders provide the possibility that we can send processing tasks from CPU to GPU. These tasks include but is not limited to procedural generation (e.g. terrain creation), physics simulation, etc. In our case, we use them to replace the role of geometry shader in the graphics pipeline. Compute buffers are the places where these two processing units communicate data. We will define some data structures here.</p>
<p><img src="http://kylehalladay.com/images/post_images/2014-06-30/gpgpu.jpg" alt="" title="Comparison between CPU and GPU (source is attached)"></p>
<p>There are a bunch of great tutorials regarding compute shaders. I recommend going over the following videos in order to have a conceptual and practical overview of this technique.</p>
<ol>
<li><a href="https://youtu.be/BrZ4pWwkpto" target="_blank" rel="noopener">Getting Started with Compute Shaders in Unity</a> (by Game Dev Guide)</li>
<li><a href="https://youtu.be/EB5HiqDl7VE" target="_blank" rel="noopener">Intro to Compute Shaders in Unity URP! Replace Geometry Shaders</a> (by NedMakesGames)</li>
</ol>
<p>From the first video, you basically learn what compute shader is and how it works. From the second one, it is more like a step-by-step tutorial that teaches you to create an interesting effect. The author also made several follow-up videos on using compute shaders in practice.</p>
<p>To be honest, once you have done the second one, you will find the setup very intimidating. Unlike using geometry shaders, everything has to be defined manually, which makes the code a bit lengthy and tedious. Also, during the procress you have to be careful, because it could be difficult to find out why it does not work. From my experience in Unity 2019 4.18 f1, it makes Unity crash more frequently as well. </p>
<p>Therefore, one tip is that if you execute the renderer script in <code>[ExecuteInEditMode]</code> every time before you update the script youâ€™d better disable the object first and enable it after you believe the code is right.</p>
<h3 id="Rendering-Workflow"><a href="#Rendering-Workflow" class="headerlink" title="Rendering Workflow"></a>Rendering Workflow</h3><p>Once you are familiar with compute shaders, it is time to apply them to actual usage. Let us first recall what the rendering flow looks like if you use the geometry shader. Data from a mesh is uploaded to GPUâ€™s buffers and gets passed down from vertex shaders to fragment shaders. Actually there are other shaders in between but here we just ignore them for now. The geometry shader is placed in the middle.</p>
<p><img src="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/5c7ag.png" alt="" title="Rendering Workflow with Geometry Shaders"></p>
<p>However, if we use compute shaders to implement the same functionality, the ordering is quite different. In this case, the compute shader goes first. We use C# script to upload mesh data from CPU to GPU and to trigger the compute shader to start processing the data. This data will then be stored in a specific compute buffer from which the vertex shader can read the processed data (vertices and triangles). Compute Shaders are not placed between vertex and fragment shaders.</p>
<p><img src="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/44sn3.png" alt="" title="Rendering Workflow with Compute Shaders"></p>
<p>As a novice to this topic, I felt confused because I did not notice the difference and still had the original workflow in my mind. Again, once you notice the difference, you will understand why those data structures in compute buffers are defined in such ways.</p>
<h3 id="Compute-Shader-Setup"><a href="#Compute-Shader-Setup" class="headerlink" title="Compute Shader Setup"></a>Compute Shader Setup</h3><p><strong>[Source Code]</strong> <a href="https://gist.github.com/junhaowww/fb6c030c17fe1e109a34f1c92571943f#file-skylikegrasscompute-compute" target="_blank" rel="noopener">SkylikeGrassCompute.compute</a></p>
<p>To write a compute shader for our grass, we first need to define some structures to manage the data. Again, if you find something not being described here, please go through the two videos about compute shaders first!</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> SourceVertex</span><br><span class="line">&#123;</span><br><span class="line">    float3 positionOS;</span><br><span class="line">    float3 normalOS;</span><br><span class="line">    float2 uv;      <span class="comment">// widthMultiplier, heightMultiplier</span></span><br><span class="line">    float3 color;   <span class="comment">// brush color</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> DrawVertex</span><br><span class="line">&#123;</span><br><span class="line">    float3 positionWS;</span><br><span class="line">    float2 uv;</span><br><span class="line">    float3 brushColor;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> DrawTriangle</span><br><span class="line">&#123;</span><br><span class="line">    float3 normalOS;</span><br><span class="line">    float3 pivotWS;         <span class="comment">// for billboard effect</span></span><br><span class="line">    DrawVertex vertices[<span class="number">3</span>]; <span class="comment">// three points on the triangle</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p> <code>SourceVertex</code> represents the data from the mesh (remember the mesh is created by the painter tool). <code>DrawVertex</code> and <code>DrawTriangle</code> represent the data generated from this compute shader and they should be redefined in the vertex shader. Then we have the buffers as follows:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">StructuredBuffer&lt;SourceVertex&gt;       _SourceVertices;</span><br><span class="line">AppendStructuredBuffer&lt;DrawTriangle&gt; _DrawTriangles;</span><br></pre></td></tr></table></figure>
<p>After that, we define some variables before writing the kernel function. They will be set up by the renderer script.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span>      _NumSourceVertices;</span><br><span class="line">float4x4 _LocalToWorld;  <span class="comment">// UNITY_MATRIX_M</span></span><br><span class="line"><span class="keyword">float</span>    _CurrentTime;   <span class="comment">// _Time</span></span><br></pre></td></tr></table></figure>
<p>Note that in a compute shader we cannot access many built-in shader variables and functions such as <code>_Time</code>, <code>UNITY_MATRIX_M</code>, etc. We have to define them by ourselves and set them via C# scripts. It is a mistake you might make. Therefore, I recommend not including these <code>.hlsl</code> files at the first place. If you plan to use them, make sure the variables or functions you use are supported in compute shaders.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Packages/com.unity.render-pipelines.universal/ShaderLibrary/Lighting.hlsl"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Packages/com.unity.render-pipelines.universal/ShaderLibrary/Shadows.hlsl"</span></span></span><br></pre></td></tr></table></figure>
<h3 id="Grass-Texture-Plane"><a href="#Grass-Texture-Plane" class="headerlink" title="Grass Texture Plane"></a>Grass Texture Plane</h3><p>Before moving to the renderer section, let us understand how to draw the triangles needed to hold the grass texture.</p>
<p>If you are new to shader scripts, I suggest going over the following tutorials:</p>
<ol>
<li><a href="https://www.cyanilux.com/tutorials/intro-to-shaders/" target="_blank" rel="noopener">Intro to Shaders</a> (by Cyanilux)</li>
<li><a href="https://roystan.net/articles/grass-shader.html" target="_blank" rel="noopener">Grass Shader</a> (by Roystan)</li>
<li><a href="https://github.com/Unity-Technologies/Graphics/tree/master/com.unity.render-pipelines.universal/Shaders" target="_blank" rel="noopener">Unity URP Shader Examples</a></li>
</ol>
<p>The first one teaches you HLSL shaders from scratch, while the second one is a good practical tutorial to help you get more familiar with shader scripts and geometry shader (but it is not written for URP).  Unity URP shader examples are also a great place where you can find answers to your questions.</p>
<p>To display a texture, we need two triangles to make up a plane to hold the texture. At the end of the shader, we append these two triangles (six vertices) to <code>_DrawTriangles</code> buffer.</p>
<h4 id="Size-Variations"><a href="#Size-Variations" class="headerlink" title="Size Variations"></a>Size Variations</h4><p>Texture size is defined by <code>_TexWidth</code> and <code>_TexHeight</code>. The size can further be changed by two ways: </p>
<ol>
<li>Multipliers from painter brush</li>
<li>Randomness</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">_TexWidth *= sv.uv.x;   <span class="comment">// width multiplier</span></span><br><span class="line">_TexHeight *= sv.uv.y;  <span class="comment">// height multiplier</span></span><br><span class="line"></span><br><span class="line">_TexWidth *= clamp(rand(sv.positionOS.zyx), <span class="number">1</span> - _TexRandomWidth, <span class="number">1</span> + _TexRandomWidth);</span><br><span class="line">_TexHeight *= clamp(rand(sv.positionOS.xyz), <span class="number">1</span> - _TexRandomHeight, <span class="number">1</span> + _TexRandomHeight);</span><br><span class="line"><span class="comment">// for uniform size</span></span><br><span class="line"><span class="keyword">float</span> sizeMultiplier = clamp(rand(sv.positionOS.yxz), <span class="number">1</span> - _TexRandomSize, <span class="number">1</span> + _TexRandomSize);</span><br><span class="line">_TexWidth *= sizeMultiplier;</span><br><span class="line">_TexHeight *= sizeMultiplier;</span><br></pre></td></tr></table></figure>
<p>Vertex positions are defined by <code>_TexFloatHeight</code>, size, and absolute world directions (<code>world up</code>, <code>world right</code>). Rotating the object does not affect the rotation of grass.</p>
<p><img src="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/8tx4z.png" alt="" title="Triangles on Different Types of Surfaces"></p>
<h4 id="Wind"><a href="#Wind" class="headerlink" title="Wind"></a>Wind</h4><p>To apply swaying effect on grass, vertex positions are changed based on <code>_CurrentTime</code>. However, rather than using absolute world directions, we go with directions based on the surface (something like the basis vectors in tangent space).</p>
<p><img src="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/h16u4.gif" alt="" title="Swaying on the Surface"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">float3 v0 = sv.positionOS.xyz;</span><br><span class="line">float2 windOffset = float2(<span class="built_in">sin</span>(_CurrentTime.x * _WindSpeed + v0.x)</span><br><span class="line">                               + <span class="built_in">sin</span>(_CurrentTime.x * _WindSpeed + v0.z * <span class="number">2</span>)</span><br><span class="line">                               + <span class="built_in">sin</span>(_CurrentTime.x * _WindSpeed * <span class="number">0.1</span> + v0.x),  <span class="comment">// right</span></span><br><span class="line">                           <span class="built_in">cos</span>(_CurrentTime.x * _WindSpeed + v0.x * <span class="number">2</span>)</span><br><span class="line">                               + <span class="built_in">cos</span>(_CurrentTime.x * _WindSpeed + v0.z));  <span class="comment">// forward</span></span><br><span class="line"><span class="keyword">float</span> windLeaningOffset = windOffset.x * _WindLeaningDist * <span class="number">0.01</span>;</span><br><span class="line">windOffset *= _WindStrength * <span class="number">0.1</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/j1w4w.gif" alt="" title="Leaning Effect"></p>
<p>The variable <code>windLeaningOffset</code> controls the amount of distance that the grass leans. Currently it just leans randomly. If you are interested in making the effect that the grass leans towards the direction it moves, check out the code <a href="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/0u3hh.png" target="_blank" rel="noopener">here</a>. It is a bit tricky to get the actual moving direction because we will apply billboard effect to the grass in the vertex shader, which make it always face the camera.</p>
<h4 id="Interactivity"><a href="#Interactivity" class="headerlink" title="Interactivity"></a>Interactivity</h4><p>The code snippet comes from <a href="https://www.patreon.com/posts/grass-geometry-1-40090373" target="_blank" rel="noopener">here</a>. It is straightforward.</p>
<p><img src="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/paz32.gif" alt="" title="Interactivity"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Interactivity</span></span><br><span class="line">float3 dis = distance(_MovingPosition, positionWS);</span><br><span class="line">float3 radius = <span class="number">1</span> - saturate(dis / _InteractorRadius);</span><br><span class="line"><span class="comment">// in world radius based on objects interaction radius</span></span><br><span class="line">float2 interactorOffset = positionWS.xz - _MovingPosition.xz; <span class="comment">// position comparison</span></span><br><span class="line">interactorOffset *= radius; <span class="comment">// position multiplied by radius for falloff</span></span><br><span class="line"><span class="comment">// increase strength</span></span><br><span class="line">interactorOffset = clamp(interactorOffset.xy * _InteractorStrength, <span class="number">-0.8</span>, <span class="number">0.8</span>);</span><br></pre></td></tr></table></figure>
<h4 id="LOD"><a href="#LOD" class="headerlink" title="LOD"></a>LOD</h4><p>Applying LOD is a great way to improve performance in a large outdoor environment. When the distance between the grass and the camera is greater than <code>_HideDistance</code>, the grass does not show up.</p>
<p><img src="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/usb0f.gif" alt="" title="Level of Detail (LOD), Hide Distance = 20"></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">float3 positionWS = mul(_LocalToWorld, float4(sv.positionOS, <span class="number">1</span>)).xyz;</span><br><span class="line"><span class="keyword">float</span> distanceFromCamera = distance(positionWS, _CameraPositionWS);</span><br><span class="line"><span class="keyword">if</span> (distanceFromCamera &gt; _HideDistance)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Combined"><a href="#Combined" class="headerlink" title="Combined"></a>Combined</h4><p>With all the offset calculations above, it is ready to put them into a function and set up the output data.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Generate each vertex for output triangles</span></span><br><span class="line"><span class="function">DrawVertex <span class="title">GenerateVertex</span><span class="params">(float3 positionWS, float3 rightDirWS, float3 forwardDirWS,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">float</span> startHeight, <span class="keyword">float</span> verticalOffset, <span class="keyword">float</span> horizonOffset,</span></span></span><br><span class="line"><span class="function"><span class="params">                          float2 windOffset, <span class="keyword">float</span> windLeaningOffset, float2 interactorOffset,</span></span></span><br><span class="line"><span class="function"><span class="params">                          float2 uv, float3 color)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DrawVertex output;</span><br><span class="line">    <span class="comment">// Position</span></span><br><span class="line">    positionWS += float3(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>) * (startHeight + verticalOffset);</span><br><span class="line">    positionWS += float3(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>) * horizonOffset;</span><br><span class="line">    <span class="comment">// Offset</span></span><br><span class="line">    positionWS += rightDirWS * (windOffset.x + windLeaningOffset - interactorOffset.x);</span><br><span class="line">    positionWS += forwardDirWS * (windOffset.y - interactorOffset.y);  <span class="comment">// forward</span></span><br><span class="line">    output.positionWS = positionWS;</span><br><span class="line">    <span class="comment">// UV</span></span><br><span class="line">    output.uv = uv;</span><br><span class="line">    <span class="comment">// Color</span></span><br><span class="line">    output.brushColor = color;</span><br><span class="line">    <span class="keyword">return</span> output;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span><span class="params">(uint3 id : SV_DispatchThreadID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bottom-Left Triangle</span></span><br><span class="line">    DrawTriangle tri = (DrawTriangle) <span class="number">0</span>;</span><br><span class="line">    tri.vertices[<span class="number">0</span>] = GenerateVertex(positionWS, surfaceRightDirWS, surfaceForwardDirWS,</span><br><span class="line">                                    _TexFloatHeight, <span class="number">0</span>, -_TexWidth / <span class="number">2</span>, windOffset, -windLeaningOffset,</span><br><span class="line">                                    interactorOffset, float2(<span class="number">1</span>, <span class="number">0</span>), sv.color);</span><br><span class="line">    tri.vertices[<span class="number">1</span>] = GenerateVertex(positionWS, surfaceRightDirWS, surfaceForwardDirWS,</span><br><span class="line">                                    _TexFloatHeight, <span class="number">0</span>, _TexWidth / <span class="number">2</span>, windOffset, -windLeaningOffset,</span><br><span class="line">                                    interactorOffset, float2(<span class="number">0</span>, <span class="number">0</span>), sv.color);</span><br><span class="line">    tri.vertices[<span class="number">2</span>] = GenerateVertex(positionWS, surfaceRightDirWS, surfaceForwardDirWS,</span><br><span class="line">                                    _TexFloatHeight, _TexHeight, -_TexWidth / <span class="number">2</span>, windOffset, windLeaningOffset,</span><br><span class="line">                                    interactorOffset, float2(<span class="number">1</span>, <span class="number">1</span>), sv.color);</span><br><span class="line">    tri.normalWS = worldUp;</span><br><span class="line">    float3 pivotWS = (tri.vertices[<span class="number">1</span>].positionWS + tri.vertices[<span class="number">2</span>].positionWS) / <span class="number">2.0</span>;</span><br><span class="line">    tri.pivotWS = pivotWS;</span><br><span class="line">    _DrawTriangles.Append(tri);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Top-Right triangle</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Renderer-Setup"><a href="#Renderer-Setup" class="headerlink" title="Renderer Setup"></a>Renderer Setup</h3><p><strong>Source:</strong> <a href="https://gist.github.com/junhaowww/fb6c030c17fe1e109a34f1c92571943f#file-skylikegrasscomputerenderer-cs" target="_blank" rel="noopener">SkylikeGrassComputeRenderer.cs</a></p>
<p>At this time, we have finished writing the compute shader. Rather than using <code>MeshRenderer</code>, we write up our own renderer script to execute the task in the compute shader and trigger drawing methods.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">ExecuteInEditMode</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SkylikeGrassComputeRenderer</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Structure</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">struct</span> SourceVertex</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> Vector3 position; <span class="keyword">public</span> Vector3 normal;</span><br><span class="line">        <span class="keyword">public</span> Vector2 uv;       <span class="keyword">public</span> Vector3 color;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Definitions of Buffers, Stride Constants, etc</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnValidate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Set up components</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEnable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Initialize</span></span><br><span class="line">        <span class="comment">// Set up buffer data and upload it to GPU</span></span><br><span class="line">        m_Initialized = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDisable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_Initialized)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Release buffers</span></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        m_Initialized = <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LateUpdate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Refresh the output buffer</span></span><br><span class="line">        <span class="comment">// Update data (e.g. _CurrentTime, _LocalToWorld, etc)</span></span><br><span class="line">        <span class="comment">// Draw</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Vertex-Shader"><a href="#Vertex-Shader" class="headerlink" title="Vertex Shader"></a>Vertex Shader</h2><p><strong>Source:</strong> <a href="https://gist.github.com/junhaowww/fb6c030c17fe1e109a34f1c92571943f#file-skylikegrass-shader" target="_blank" rel="noopener">SkylikeGrass.shader</a>, <a href="https://gist.github.com/junhaowww/fb6c030c17fe1e109a34f1c92571943f#file-skylikegrass-hlsl" target="_blank" rel="noopener">SkylikeGrass.hlsl</a></p>
<p>Following the tutorial made by NedMakesGames, I found that splitting code into <code>.shader</code> and <code>.hlsl</code> files is a good way to organize lengthy shader code. In the <code>.shader</code> file, it mainly sets up SubShader, Pass, and enable keywords we need. In the <code>.hlsl</code> file, it first defines the buffer and structures we used before in the compute shader, which are <code>DrawVertex</code> and <code>DrawTriangle</code>. After that, it contains vertex and fragment functions.</p>
<p>Unlike many other vertex functions, in our case we retrieve the data by <code>SV_VertexID</code>. Once we have the data, we set it up in a <code>v2f</code> struct so the fragment function is able to retrieve the data it needs.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">v2f <span class="title">vert</span><span class="params">(uint vertexID : SV_VertexID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Initialize the output struct</span></span><br><span class="line">    v2f output;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the vertex from the buffer</span></span><br><span class="line">    DrawTriangle tri = _DrawTriangles[vertexID / <span class="number">3</span>];</span><br><span class="line">    DrawVertex input = tri.vertices[vertexID % <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>To achieve the billboard effect, we need to transform vertex positions such that the plane is always facing our main camera. There are already a bunch of methods existing on the Internet. I found the following video helpful.</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=qGppGvgw7Dg&amp;t=982s&amp;ab_channel=Aperium" target="_blank" rel="noopener">Unity Shader Tutorial - Billboard Shader</a> (by Aperium)</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Billboard</span></span><br><span class="line">float4 pivotWS = float4(tri.pivotWS, <span class="number">1</span>);</span><br><span class="line">float4 pivotVS = mul(UNITY_MATRIX_V, pivotWS);</span><br><span class="line"></span><br><span class="line">float4 worldPos = float4(input.positionWS, <span class="number">1</span>);</span><br><span class="line">float4 flippedWorldPos = float4(<span class="number">-1</span>, <span class="number">1</span>, <span class="number">-1</span>, <span class="number">1</span>) * (worldPos - pivotWS) + pivotWS;</span><br><span class="line">float4 viewPos = flippedWorldPos - pivotWS + pivotVS;</span><br><span class="line">output.positionCS = mul(UNITY_MATRIX_P, viewPos);</span><br></pre></td></tr></table></figure>
<p>This code is pretty much the same with the one in the video. The pivot position of the grass plane is calculated in the compute shader. </p>
<p><img src="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/vfeyh.png" alt="" title="Calculate New View Position (ignore flipped world position)"></p>
<p>Personally, I did not completely understand all the detail, but I think it has something to do with the view matrix. It has changed what the matrix previously does such that it can rotate the grass plane towards us. Note that in the illustration it just ignores flipping, which is explained in the video. If you know this well, please teach me in the comment!</p>
<h2 id="Fragment-Shader"><a href="#Fragment-Shader" class="headerlink" title="Fragment Shader"></a>Fragment Shader</h2><p><strong>Source:</strong> <a href="https://gist.github.com/junhaowww/fb6c030c17fe1e109a34f1c92571943f#file-skylikegrass-shader" target="_blank" rel="noopener">SkylikeGrass.shader</a>, <a href="https://gist.github.com/junhaowww/fb6c030c17fe1e109a34f1c92571943f#file-skylikegrass-hlsl" target="_blank" rel="noopener">SkylikeGrass.hlsl</a></p>
<p>In fragment shader, base color is lerped between <code>_BaseColor</code> and <code>_TopColor</code> based on the Y texture coordinate. I use two colors here but you can definitely turn it into one only. By multiplying the result with brush color, we are able to override the color for each grass entity via the painter tool.</p>
<p>Both ambient and diffuse components contribute to final color. You can tweak ambient strength to make it look good in a night scene, then increase diffuse strength to what you want. Setting a larger diffuse color sometimes gives you better result if you have bloom effect enabled.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Light mainLight = GetMainLight();</span><br><span class="line"></span><br><span class="line">float3 baseColor = lerp(_BaseColor, _TopColor, saturate(input.uv.y)) * input.brushColor;</span><br><span class="line"></span><br><span class="line">float3 ambient = baseColor * _AmbientStrength;</span><br><span class="line">float3 diffuse = baseColor * _DiffuseStrength;</span><br><span class="line"></span><br><span class="line"><span class="keyword">float</span> NdotL = max(<span class="number">0</span>, dot(mainLight.direction, input.normalWS));</span><br><span class="line">diffuse *= NdotL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Combine</span></span><br><span class="line">float4 combined = float4(ambient + diffuse, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>If you watch the grass carefully in Sky, you should notice that the grass is highlighted when players tramping on top of it. It is a subtle effect but I found it very interesting and the implementation is not difficult once you have the speed percentage along the moving direction of your player object (<code>current speed</code> / <code>max speed</code>).</p>
<p><img src="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/641jj.gif" alt="" title="Highlighted Grass in Sky: Children of the Light"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Interactor Highlight</span></span><br><span class="line"><span class="keyword">float</span> distFromMovingPosition = distance(_MovingPosition, input.positionWS);</span><br><span class="line"><span class="keyword">if</span> (distFromMovingPosition &lt; _HighlightRadius)</span><br><span class="line">&#123;</span><br><span class="line">    combined.rgb *= (<span class="number">1</span> + _MovingSpeedPercent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>At this point, you should be able to see an opaque and rectangular plane swaying above the surface. To make it look better, we enable alpha testing and transparency in <code>.shader</code> file, sample the alpha channel of the texture, and multiply it with the combined RGB and alpha values.</p>
<p><img src="https://bloggg-1254259681.cos.na-siliconvalley.myqcloud.com/sypqs.png" alt="" title="Enable Transparency"></p>
<p>You can find the texture files at the beginning of this article. If you are a creative person, you can definitely create your own textures to make it more aesthetic.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Texture Mask Color (pure white + alpha)</span></span><br><span class="line">half4 texMaskColor = SAMPLE_TEXTURE2D(_BaseTex, sampler_BaseTex, input.uv);</span><br><span class="line"><span class="keyword">return</span> combined * texMaskColor;  <span class="comment">// I also multiply rgb values, but it is okay if it is pure white</span></span><br></pre></td></tr></table></figure>
<h2 id="Other-Stuff"><a href="#Other-Stuff" class="headerlink" title="Other Stuff"></a>Other Stuff</h2><h3 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h3><p>So far, I have not noticed any performance issue. Although after adding a huge amount of grass to the scene and even at the same time turning off LOD, there is no significant drop of FPS. I will follow up on that if I discover any issue.</p>
<h3 id="Known-Issues"><a href="#Known-Issues" class="headerlink" title="Known Issues"></a>Known Issues</h3><ol>
<li>Shadow cast does not work as expected. Currently I do not figure out why. It has some weird effect. If two renderers enable shadow cast at the same time, it starts blinking. However, for my game, I do not intend to enable shadow cast for now.</li>
<li>In Metal, the console sometimes pops up many warnings, which is annoying. Is it a bug? I havenâ€™t not found a solution to that yet.</li>
</ol>
<p>Thanks for reading! If you like this grass, please let me know in the comment!</p>
<h2 id="References-amp-Credits"><a href="#References-amp-Credits" class="headerlink" title="References &amp; Credits"></a>References &amp; Credits</h2><ul>
<li>MinionsArt<ul>
<li><a href="https://www.youtube.com/watch?v=xKJHL8nQiuM&amp;ab_channel=MinionsArt" target="_blank" rel="noopener">Unity - I made an Interactive Grass Shader + Tool</a></li>
<li><a href="https://www.patreon.com/posts/geometry-grass-46836032" target="_blank" rel="noopener">Geometry Grass Shader + Tool video + update</a></li>
<li><a href="https://www.patreon.com/posts/grass-geometry-1-40090373" target="_blank" rel="noopener">Grass Geometry Shader with Interactivity (Part 1, the shader)</a></li>
<li><a href="https://www.patreon.com/posts/grass-geometry-2-40077798" target="_blank" rel="noopener">Grass Geometry Shader with Interactivity (Part 2, the editor tool)</a></li>
<li><a href="https://www.patreon.com/posts/geometry-grass-47447321" target="_blank" rel="noopener">Geometry Grass Shader for URP</a></li>
</ul>
</li>
<li>Ned Makes Game<ul>
<li><a href="https://www.youtube.com/watch?v=EB5HiqDl7VE&amp;ab_channel=NedMakesGames" target="_blank" rel="noopener">Intro to Compute Shaders in Unity URP! Replace Geometry Shaders</a></li>
<li><a href="https://www.youtube.com/watch?v=DeATXF4Szqo&amp;ab_channel=NedMakesGames" target="_blank" rel="noopener">Grass Fields in Unity URP! Generate Blades with Compute Shaders!</a></li>
</ul>
</li>
<li>Game Dev Guide: <a href="https://www.youtube.com/watch?v=BrZ4pWwkpto&amp;ab_channel=GameDevGuide" target="_blank" rel="noopener">Getting Started with Compute Shaders in Unity</a></li>
<li>Kyle Halladay: <a href="http://kylehalladay.com/blog/tutorial/2014/06/27/Compute-Shaders-Are-Nifty.html" target="_blank" rel="noopener">Getting Started With Compute Shaders In Unity</a></li>
<li>Cyanilux: <a href="https://www.cyanilux.com/tutorials/intro-to-shaders/" target="_blank" rel="noopener">Intro to Shaders</a></li>
<li>Roystan: <a href="https://roystan.net/articles/grass-shader.html" target="_blank" rel="noopener">Grass Shader</a></li>
<li>Unity-Technologies: <a href="https://github.com/Unity-Technologies/Graphics/tree/master/com.unity.render-pipelines.universal/Shaders" target="_blank" rel="noopener">URP Shader Examples</a></li>
<li>Aperium: <a href="https://www.youtube.com/watch?v=qGppGvgw7Dg&amp;t=982s&amp;ab_channel=Aperium" target="_blank" rel="noopener">Unity Shader Tutorial - Billboard Shader</a></li>
</ul>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:</strong>
    Junhao Wang
  </li>
  <li class="post-copyright-link">
    <strong>Post link:</strong>
    <a href="http://www.junhaow.com/2021/03/06/050 | Making Sky's Stylized Grass with Compute Shader in Unity/" title="Making Sky's Stylized Grass with Compute Shader in Unity">http://www.junhaow.com/2021/03/06/050 | Making Sky's Stylized Grass with Compute Shader in Unity/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice: </strong>
    All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> unless stating additionally.
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Unity/" rel="tag"># Unity</a>
          
            <a href="/tags/Shader/" rel="tag"># Shader</a>
          
            <a href="/tags/URP/" rel="tag"># URP</a>
          
            <a href="/tags/Compute-Shader/" rel="tag"># Compute Shader</a>
          
            <a href="/tags/Sky/" rel="tag"># Sky</a>
          
            <a href="/tags/Grass/" rel="tag"># Grass</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/11/12/049 | Understand Interface and Abstract Class in Java/" rel="next" title="Understand Interface and Abstract Class in Java">
                <i class="fa fa-chevron-left"></i> Understand Interface and Abstract Class in Java
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/cat_with_glasses.jpg" alt="Junhao Wang">
            
              <p class="site-author-name" itemprop="name">Junhao Wang</p>
              <p class="site-description motion-element" itemprop="description">Debug the old world, bug the new world!</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">50</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">118</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://www.facebook.com/chuckwangg" target="_blank" title="Facebook">
                      
                        <i class="fa fa-fw fa-facebook"></i>Facebook</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/junhaowww" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.linkedin.com/in/junhaowww/" target="_blank" title="LinkedIn">
                      
                        <i class="fa fa-fw fa-linkedin"></i>LinkedIn</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.douban.com/people/maodai/" target="_blank" title="è±†ç“£ (Book)">
                      
                        <i class="fa fa-fw fa-book"></i>è±†ç“£ (Book)</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.jianshu.com/u/41865efdad5d/" title="Xiaofud" target="_blank">Xiaofud</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.davex.pw/" title="DaveX" target="_blank">DaveX</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://alexfan.xyz/" title="alexfan.xyz" target="_blank">alexfan.xyz</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#How-To-Set-Up-TL-DR"><span class="nav-number">1.</span> <span class="nav-text">How To Set Up (TL;DR)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Usage"><span class="nav-number">1.1.</span> <span class="nav-text">Usage</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Painter-Tool"><span class="nav-number">2.</span> <span class="nav-text">Painter Tool</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Compute-Shader"><span class="nav-number">3.</span> <span class="nav-text">Compute Shader</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Learning-Resources"><span class="nav-number">3.1.</span> <span class="nav-text">Learning Resources</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Rendering-Workflow"><span class="nav-number">3.2.</span> <span class="nav-text">Rendering Workflow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Compute-Shader-Setup"><span class="nav-number">3.3.</span> <span class="nav-text">Compute Shader Setup</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Grass-Texture-Plane"><span class="nav-number">3.4.</span> <span class="nav-text">Grass Texture Plane</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Size-Variations"><span class="nav-number">3.4.1.</span> <span class="nav-text">Size Variations</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Wind"><span class="nav-number">3.4.2.</span> <span class="nav-text">Wind</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Interactivity"><span class="nav-number">3.4.3.</span> <span class="nav-text">Interactivity</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#LOD"><span class="nav-number">3.4.4.</span> <span class="nav-text">LOD</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Combined"><span class="nav-number">3.4.5.</span> <span class="nav-text">Combined</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Renderer-Setup"><span class="nav-number">3.5.</span> <span class="nav-text">Renderer Setup</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vertex-Shader"><span class="nav-number">4.</span> <span class="nav-text">Vertex Shader</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Fragment-Shader"><span class="nav-number">5.</span> <span class="nav-text">Fragment Shader</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Other-Stuff"><span class="nav-number">6.</span> <span class="nav-text">Other Stuff</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Performance"><span class="nav-number">6.1.</span> <span class="nav-text">Performance</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Known-Issues"><span class="nav-number">6.2.</span> <span class="nav-text">Known Issues</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References-amp-Credits"><span class="nav-number">7.</span> <span class="nav-text">References &amp; Credits</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Junhao Wang</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>








        
<div class="busuanzi-count">
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    
      <div id="needsharebutton-float">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://junhaow.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://www.junhaow.com/2021/03/06/050 | Making Sky's Stylized Grass with Compute Shader in Unity/';
          this.page.identifier = '2021/03/06/050 | Making Sky's Stylized Grass with Compute Shader in Unity/';
          this.page.title = 'Making Sky\'s Stylized Grass with Compute Shader in Unity';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://junhaow.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
    
      flOptions = {};
      
          flOptions.iconStyle = "box";
      
          flOptions.boxForm = "horizontal";
      
          flOptions.position = "middleRight";
      
          flOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-float', flOptions);
    
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

  

  
  


  

  


</body>
</html>
